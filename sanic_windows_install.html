<!DOCTYPE html>
<html lang="chinese (simplified)">

<head>
  <!-- Required meta tags always come first -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>sanic在windows上的部署 | 编程岁月
</title>
  <link rel="canonical" href="/sanic_windows_install.html">



  <link rel="stylesheet" href="/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="/theme/css/style.css">


<meta name="description" content="异步是提高web并发性能（非并行）的关键.python从3.4发展到目前的3.6，最大的改进就是协程的语言级别支持（async/await）以及异步IO库(asyncio)的标准化。sanic则是一个基于python协程技术、类Flask风格的异步web微框架,它底层依赖于uvloop和httptools。不幸的是uvloop和httptools目前均不支持windows，也未看到支持的计划。幸运的是sanic对uvloop的依赖是可选的，虽然性能有所损失。对windows用户而言，可直接采用asyncio缺省的ProactorEventLoop事件循环。然而,saninc对httptools的依赖是必选的，所以需要将httptools移植到windows。 安装环境 操作系统: windows 10 专业版 python: 3.6.4 安装目录为: c:\python36 httptools: 0.0.10 sanic: 0.7.0 编译器: Visual …">
</head>

<body>
  <header class="header">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1 class="title"><a href="">编程岁月</a></h1>
          <p class="text-muted">无名</p>
          <ul class="list-inline">
            <li class="list-inline-item"><a href="https://github.com/hlqyq" target="_blank">github</a></li>
            <li class="list-inline-item"><a href="http://www.justtodo.com/" target="_blank">晓月刀</a></li>
            <li class="list-inline-item"><a href="http://www.csew.cn/" target="_blank">易睿</a></li>
            <li class="list-inline-item"><a href="https://www.fullstackpython.com/" target="_blank">Full Stack Python</a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>sanic在windows上的部署
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2017-12-29T00:00:00+08:00">
        <i class="fa fa-clock-o"></i>
        周五 29 十二月 2017
      </li>
      <li class="list-inline-item">
        <i class="fa fa-folder-open-o"></i>
        <a href="/category/bands.html">bands</a>
      </li>
      <li class="list-inline-item">
        <i class="fa fa-user-o"></i>
        <a href="/author/hu-le-qiu.html">胡乐秋</a>      </li>
    </ul>
  </header>
  <div class="content">
    <p>异步是提高web并发性能（非并行）的关键.python从3.4发展到目前的3.6，最大的改进就是协程的语言级别支持（async/await）以及异步IO库(asyncio)的标准化。<a href="https://github.com/channelcat/sanic/">sanic</a>则是一个基于python协程技术、类Flask风格的异步web微框架,它底层依赖于<a href="http://github.com/MagicStack/uvloop">uvloop</a>和<a href="https://pypi.python.org/pypi/httptools/0.0.10">httptools</a>。不幸的是uvloop和httptools目前均不支持windows，也未看到支持的计划。幸运的是sanic对uvloop的依赖是可选的，虽然性能有所损失。对windows用户而言，可直接采用asyncio缺省的ProactorEventLoop事件循环。然而,saninc对httptools的依赖是必选的，所以需要将httptools移植到windows。</p>
<h1>安装环境</h1>
<ul>
<li>操作系统: windows 10 专业版</li>
<li>python: 3.6.4 安装目录为: c:\python36</li>
<li>httptools: 0.0.10</li>
<li>sanic: 0.7.0</li>
<li>编译器: Visual studio 2013 专业版 sp4</li>
</ul>
<h1>httptools的windows编译</h1>
<ul>
<li>从<a href="http://pypi.python.org">pypi</a>下载<a href="https://pypi.python.org/pypi/httptools">httptools</a>文件httptools-0.0.10.tar.gz;</li>
<li>解压到编译目录,如: D:\httptools</li>
<li>打开Visual studio 2013,新建Visiual C++ “Win 32”项目，项目位置为: D:\, 名称为: httptools, 去除“未解决方案专家目录”，点击“确定”,进入下一页;</li>
<li>点击“下一步”；</li>
<li>选择应用程序类型为“DLL”,附件选项为“空项目”，点击“完成”；</li>
<li>在“解决方案资源管理器”面板顶部工具条，点击“显示所有文件”工具图标；</li>
<li>将文件"httptools/parser/parser.c"、"vendor/http-parser/http_parser.c"包含到项目中;</li>
<li>在标准工具条中“Win32"下拉列表中选择“配置管理器”，将平台"Win32"更改为“x64”,编译版本选择为"Release";</li>
<li>在"解决方案资源管理器"窗口中，选择项目"httptools",右键，选择属性；</li>
<li>在“配置属性”中展开"C/C++",选择"常规",在附加包含目录中增加python头文件目录: c:\python36\include;</li>
<li>在“链接器”下的“常规”页面中的附加库目录，添加python库文件目录： c:\python36\libs;</li>
<li>按"F7"进行编译，在“x64\Release”子目录下会生成"httptools.dll",将其更改为“httptools.pyd”,并拷贝到"httptools\parser"子目录下。</li>
</ul>
<h1>httptools安装</h1>
<ul>
<li>打开命令行窗口;</li>
<li>进入“D:\httptools”目录;</li>
<li>运行"c:\python36\python setup.py install"进行安装;</li>
<li>打开python3.6.4,输入"import httptools"验证安装成功;</li>
</ul>
<h1>sanic安装</h1>
<p>不幸的是，即便成功安装了"httptools",即便设置了SANIC_NO UVLOOP环境变量(SET SANIC_NO_UVLOOP=true),
按照<a href="https://github.com/channelcat/sanic/">sanic主页</a>所说的"pip install sanic”进行安装，依然会显示运行时错误"RuntimeError: uvloop does not support Windows at the moment". 所以只能手动安装</p>
<ul>
<li>打开<a href="https://github.com/channelcat/sanic/">sanic</a>主页，点击"Clone or download",点击"Download ZIP",下载sanic源码;</li>
<li>将源码解压到"d:\sanic-master"目录；</li>
<li>打开"d:\sanic-master\setup.py",将"requirements"列表中的“uvloop”删除；</li>
<li>将“if strtobool(os.environ.get("SANIC_NO_UVLOOP", "no")):
    print("Installing without uvLoop")
    requirements.remove(uvloop)”这三行同样删除，保存；</li>
<li>打开命令行,进入"d:\sanic-master"目录;</li>
<li>运行"c:\python36\python setup.py install"进行安装;</li>
<li>打开python3.6.4,输入"import sanic"验证安装成功;</li>
</ul>
<h1>附: asyncio页面性能测试</h1>
<p>'''</p>
<h1>!/usr/bin/python3.6</h1>
<h1>-<em>- coding: utf-8 -</em>-</h1>
<p>"""web页面性能测试"""</p>
<p>import asyncio
import re
import time
import sys</p>
<h6>######################## 元信息</h6>
<p>def get_predefined_test_page_list() -&gt; list:
    """得到预定义的测试页面列表: [[name, host, port, url, test_count, expect_content_list, timeout_seconds], ...]</p>
<div class="highlight"><pre><span></span><span class="n">Returns</span><span class="o">:</span>
    <span class="err">返回预定义测试页面列表</span>

<span class="s2">&quot;&quot;</span><span class="err">&quot;</span>
<span class="k">return</span> <span class="o">[(</span><span class="s1">&#39;微信&#39;</span><span class="o">,</span> <span class="s1">&#39;weixin.qq.com&#39;</span><span class="o">,</span> <span class="mi">80</span><span class="o">,</span> <span class="s1">&#39;/&#39;</span><span class="o">,</span> <span class="mi">500</span><span class="o">,</span> <span class="o">[</span><span class="s1">&#39;是一个生活方式&#39;</span><span class="o">,],</span> <span class="mi">50</span><span class="o">),</span>
        <span class="o">(</span><span class="s1">&#39;百度&#39;</span><span class="o">,</span> <span class="s1">&#39;www.baidu.com&#39;</span><span class="o">,</span> <span class="mi">443</span><span class="o">,</span> <span class="s1">&#39;/&#39;</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span> <span class="o">[</span><span class="s1">&#39;百度一下&#39;</span><span class="o">,],</span> <span class="mi">50</span><span class="o">),</span>
        <span class="o">(</span><span class="s1">&#39;新浪&#39;</span><span class="o">,</span> <span class="s1">&#39;www.sina.com.cn&#39;</span><span class="o">,</span> <span class="mi">80</span><span class="o">,</span> <span class="s1">&#39;/&#39;</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span> <span class="o">[</span><span class="s1">&#39;微博&#39;</span><span class="o">,],</span> <span class="mi">50</span><span class="o">),</span>
        <span class="o">(</span><span class="s1">&#39;本机主页&#39;</span><span class="o">,</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="o">,</span> <span class="mi">80</span><span class="o">,</span> <span class="s1">&#39;/&#39;</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span> <span class="o">[</span><span class="s1">&#39;hello&#39;</span><span class="o">,</span> <span class="s1">&#39;world&#39;</span><span class="o">],</span> <span class="mi">50</span><span class="o">),]</span>
</pre></div>


<h6>######################## 接口函数</h6>
<p>async def web_performance_test(name: str, host: str, port: int, url: str, test_count: int, expect_content_list: list, timeout_seconds: int) -&gt; None:
    """执行web性能测试</p>
<div class="highlight"><pre><span></span><span class="n">Args</span><span class="o">:</span>
    <span class="n">host</span><span class="o">:</span> <span class="err">服务器地址</span>
    <span class="n">port</span><span class="o">:</span> <span class="err">服务器端口</span>
    <span class="n">url</span><span class="o">:</span> <span class="err">服务器</span><span class="n">url</span>
    <span class="n">test_count</span><span class="o">:</span> <span class="err">访问测试次数</span>
    <span class="n">expect_content_list</span><span class="o">:</span> <span class="err">期望返回的页面包含内容列表</span>
    <span class="n">timeout_seconds</span><span class="o">:</span> <span class="err">超时设置</span>

<span class="s2">&quot;&quot;</span><span class="err">&quot;</span>
<span class="err">#</span> <span class="err">开始计时并访问网页</span>
<span class="n">print</span><span class="o">(</span><span class="s1">&#39;{}({}:{}{})压力测试(次数:{})...&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">url</span><span class="o">,</span> <span class="n">test_count</span><span class="o">))</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="na">clock</span><span class="o">()</span>
<span class="n">done</span><span class="o">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="na">wait</span><span class="o">([</span><span class="n">_fetch</span><span class="o">(</span><span class="n">test_index</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">url</span><span class="o">,</span> <span class="n">expect_content_list</span><span class="o">)</span> <span class="k">for</span> <span class="n">test_index</span> <span class="k">in</span> <span class="n">range</span><span class="o">(</span><span class="n">test_count</span><span class="o">)],</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="o">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="na">FIRST_EXCEPTION</span><span class="o">)</span>
<span class="n">total_elapsed</span> <span class="o">=</span> <span class="o">(</span><span class="n">time</span><span class="o">.</span><span class="na">clock</span><span class="o">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="o">)</span>
<span class="err">#</span> <span class="err">执行统计</span>
<span class="n">print</span><span class="o">(</span><span class="s1">&#39;{}\r\n&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">_statistics_performance</span><span class="o">(</span><span class="n">test_count</span><span class="o">,</span> <span class="n">total_elapsed</span><span class="o">,</span> <span class="o">[</span><span class="n">x</span><span class="o">.</span><span class="na">result</span><span class="o">()</span> <span class="k">for</span> <span class="n">x</span> <span class="k">in</span> <span class="n">done</span><span class="o">])))</span>
</pre></div>


<h6>######################## 实现</h6>
<p>REGEX_CONTENT_LENGTH = re.compile(r'\r\nContent-Length: ([0-9]+)\r\n', re.IGNORECASE)</p>
<p>def _get_content_length(header: str) -&gt; int:
    """根据http头得到内容长度</p>
<div class="highlight"><pre><span></span><span class="n">Args</span><span class="o">:</span>
    <span class="n">header</span><span class="o">:</span> <span class="err">响应头内容</span>

<span class="n">Returns</span><span class="o">:</span>
    <span class="err">返回内容长度</span>

<span class="s2">&quot;&quot;</span><span class="err">&quot;</span>
<span class="n">match</span> <span class="o">=</span> <span class="n">REGEX_CONTENT_LENGTH</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">header</span><span class="o">)</span>
<span class="k">if</span> <span class="n">match</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">int</span><span class="o">(</span><span class="n">match</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
<span class="k">return</span> <span class="mi">0</span>
</pre></div>


<p>async def _fetch(test_index: int, host: str, port: int, url: str, expect_content_list: list) -&gt; tuple:
    """访问指定网页</p>
<div class="highlight"><pre><span></span><span class="n">Args</span><span class="o">:</span>
    <span class="n">test_index</span><span class="o">:</span> <span class="err">测试次数索引</span>
    <span class="n">host</span><span class="o">:</span> <span class="err">服务器地址</span>
    <span class="n">port</span><span class="o">:</span> <span class="err">服务器端口</span>
    <span class="n">url</span><span class="o">:</span> <span class="err">服务器</span><span class="n">url</span>
    <span class="n">expect_content_list</span><span class="o">:</span> <span class="err">期望返回的页面包含内容列表</span>

<span class="n">Returns</span><span class="o">:</span>
    <span class="err">返回</span><span class="o">(</span><span class="n">True</span><span class="o">,</span> <span class="o">{</span><span class="n">elapsed_seconds</span><span class="o">})</span><span class="err">或</span><span class="o">(</span><span class="n">False</span><span class="o">,</span> <span class="o">{</span><span class="n">error_message</span><span class="o">})</span>

<span class="s2">&quot;&quot;</span><span class="err">&quot;</span>
<span class="err">#</span> <span class="err">输出信息</span>
<span class="k">if</span> <span class="n">not</span> <span class="n">test_index</span> <span class="o">%</span> <span class="mi">10</span><span class="o">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="na">stderr</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s1">&#39;&gt;&#39;</span><span class="o">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="na">stderr</span><span class="o">.</span><span class="na">flush</span><span class="o">()</span>
<span class="err">#</span> <span class="err">建立连接</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="na">clock</span><span class="o">()</span>
<span class="n">reader</span><span class="o">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="na">open_connection</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">ssl</span><span class="o">=(</span><span class="n">port</span> <span class="o">==</span> <span class="mi">443</span><span class="o">))</span>
<span class="err">#</span> <span class="err">发送请求</span>
<span class="n">query</span> <span class="o">=</span> <span class="o">(</span><span class="s1">&#39;GET {path} HTTP/1.0\r\n&#39;</span>
         <span class="s1">&#39;Host: {hostname}\r\n&#39;</span>
         <span class="s1">&#39;User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:50.0) Gecko/20100101 Firefox/50.0\r\n&#39;</span>
         <span class="s1">&#39;\r\n&#39;</span><span class="o">).</span><span class="n">format</span><span class="o">(</span><span class="n">path</span><span class="o">=</span><span class="n">url</span><span class="o">,</span> <span class="n">hostname</span><span class="o">=</span><span class="n">host</span><span class="o">)</span>
<span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">query</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s1">&#39;latin-1&#39;</span><span class="o">))</span>
<span class="err">#</span> <span class="err">读入头信息</span>
<span class="n">headers_list</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">header_crlf</span> <span class="o">=</span> <span class="n">False</span>
<span class="k">while</span> <span class="n">not</span> <span class="n">header_crlf</span><span class="o">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">await</span> <span class="n">reader</span><span class="o">.</span><span class="na">readline</span><span class="o">()</span>
    <span class="k">if</span> <span class="n">not</span> <span class="n">line</span><span class="o">:</span>
        <span class="k">break</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="s1">&#39;latin1&#39;</span><span class="o">).</span><span class="n">rstrip</span><span class="o">()</span>
    <span class="k">if</span> <span class="n">not</span> <span class="n">line</span><span class="o">:</span>
        <span class="n">header_crlf</span> <span class="o">=</span> <span class="n">True</span>
    <span class="k">else</span><span class="o">:</span>
        <span class="n">headers_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">line</span><span class="o">)</span>
<span class="err">#</span> <span class="err">获得内容长度</span>
<span class="n">headers</span> <span class="o">=</span> <span class="s1">&#39;\r\n&#39;</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">headers_list</span><span class="o">)</span>
<span class="n">content_length</span> <span class="o">=</span> <span class="n">_get_content_length</span><span class="o">(</span><span class="n">headers</span><span class="o">)</span>
<span class="err">#</span> <span class="err">读入内容</span>
<span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">if</span> <span class="n">content_length</span><span class="o">:</span>
    <span class="n">content_list</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="n">readed_length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">readed_length</span> <span class="o">&lt;</span> <span class="n">content_length</span><span class="o">:</span>
        <span class="n">read_length</span> <span class="o">=</span> <span class="n">content_length</span> <span class="o">-</span> <span class="n">readed_length</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">await</span> <span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">read_length</span><span class="o">)</span>
        <span class="k">if</span> <span class="n">content</span><span class="o">:</span>
            <span class="n">readed_length</span> <span class="o">+=</span> <span class="n">len</span><span class="o">(</span><span class="n">content</span><span class="o">)</span>
            <span class="n">content_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">content</span><span class="o">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">content_list</span><span class="o">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="na">decode</span><span class="o">()</span>
<span class="err">#</span> <span class="err">关闭</span><span class="n">socket</span>
<span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
<span class="n">elapsed</span> <span class="o">=</span> <span class="o">(</span><span class="n">time</span><span class="o">.</span><span class="na">clock</span><span class="o">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="o">)</span>
<span class="err">#</span> <span class="err">判断成功与否标志</span>
<span class="n">success</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.&#39;</span> <span class="k">in</span> <span class="n">headers</span> <span class="n">and</span> <span class="s1">&#39;200&#39;</span> <span class="k">in</span> <span class="n">headers</span>
<span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;返回状态码错误: {}&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">headers_list</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span> <span class="k">if</span> <span class="n">not</span> <span class="n">success</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<span class="k">if</span> <span class="n">success</span> <span class="n">and</span> <span class="n">expect_content_list</span> <span class="n">and</span> <span class="n">content</span><span class="o">:</span>
    <span class="k">for</span> <span class="n">expect_content</span> <span class="k">in</span> <span class="n">expect_content_list</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">expect_content</span> <span class="n">not</span> <span class="k">in</span> <span class="n">content</span><span class="o">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">False</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;服务器响应未包含期望内容:{}&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">expect_content</span><span class="o">)</span>
            <span class="k">break</span>
<span class="err">#</span> <span class="err">输出信息</span>
<span class="k">if</span> <span class="n">not</span> <span class="n">test_index</span> <span class="o">%</span> <span class="mi">10</span><span class="o">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="na">stderr</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s1">&#39;&lt;&#39;</span><span class="o">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="na">stderr</span><span class="o">.</span><span class="na">flush</span><span class="o">()</span>
<span class="err">#</span> <span class="err">返回</span>
<span class="k">if</span> <span class="n">success</span><span class="o">:</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">success</span><span class="o">,</span> <span class="n">elapsed</span><span class="o">)</span>
<span class="k">else</span><span class="o">:</span>
    <span class="k">if</span> <span class="n">not</span> <span class="n">error_message</span><span class="o">:</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;{}\r\n{}&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">headers</span><span class="o">,</span> <span class="n">content</span><span class="o">)</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">False</span><span class="o">,</span> <span class="n">error_message</span><span class="o">)</span>
</pre></div>


<p>def _statistics_performance(test_count: int, total_elapsed: float, fetch_result_list: list) -&gt; str:
    """统计测试结果</p>
<div class="highlight"><pre><span></span><span class="n">Args</span><span class="o">:</span>
    <span class="n">test_count</span><span class="o">:</span> <span class="err">总测试次数</span>
    <span class="n">total_elapsed</span><span class="o">:</span> <span class="err">总耗时</span>
    <span class="n">fetch_result_list</span><span class="o">:</span> <span class="err">测试结果列表</span>

<span class="n">Returns</span><span class="o">:</span>
    <span class="err">返回统计信息</span>

<span class="s2">&quot;&quot;</span><span class="err">&quot;</span>
<span class="err">#</span> <span class="err">分离成功与失败结果</span>
<span class="n">elapsed_seconds_list</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">failed_response_list</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">unresponse_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">fetch_result</span> <span class="k">in</span> <span class="n">fetch_result_list</span><span class="o">:</span>
    <span class="k">if</span> <span class="n">fetch_result</span> <span class="n">and</span> <span class="n">len</span><span class="o">(</span><span class="n">fetch_result</span><span class="o">)</span> <span class="o">==</span> <span class="mi">2</span><span class="o">:</span>
        <span class="n">success</span><span class="o">,</span> <span class="n">result_or_error</span> <span class="o">=</span> <span class="n">fetch_result</span>
        <span class="k">if</span> <span class="n">success</span><span class="o">:</span>
            <span class="n">elapsed_seconds_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">result_or_error</span><span class="o">)</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="n">failed_response_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">result_or_error</span><span class="o">)</span>
    <span class="k">else</span><span class="o">:</span>
        <span class="n">failed_response_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;无返回值&#39;</span><span class="o">)</span>
        <span class="n">unresponse_count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">success_count</span> <span class="o">=</span> <span class="n">len</span><span class="o">(</span><span class="n">elapsed_seconds_list</span><span class="o">)</span>
<span class="n">failed_count</span> <span class="o">=</span> <span class="n">test_count</span> <span class="o">-</span> <span class="n">success_count</span>
<span class="err">#</span> <span class="err">打印统计信息</span>
<span class="n">statistics_list</span> <span class="o">=</span> <span class="o">[]</span>
<span class="k">if</span> <span class="n">failed_response_list</span><span class="o">:</span>
    <span class="n">statistics_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;\r\n失败({}次)原因: \r\n{}&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">len</span><span class="o">(</span><span class="n">failed_response_list</span><span class="o">),</span> <span class="s1">&#39;\r\n&#39;</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">failed_response_list</span><span class="o">)))</span>
<span class="n">statistics_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;\r\n统计结果:&#39;</span><span class="o">)</span>
<span class="n">statistics_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;  测试次数: {}&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">test_count</span><span class="o">))</span>
<span class="n">statistics_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;  成功次数: {}    成功率: {:.2f}%&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">success_count</span><span class="o">,</span> <span class="n">success_count</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">test_count</span><span class="o">))</span>
<span class="n">statistics_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;  失败次数: {}    失败率: {:.2f}%&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">test_count</span> <span class="o">-</span> <span class="n">success_count</span><span class="o">,</span> <span class="n">failed_count</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">test_count</span><span class="o">))</span>
<span class="n">statistics_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;  总耗时(秒): {:.3f}&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">total_elapsed</span><span class="o">))</span>
<span class="k">if</span> <span class="n">elapsed_seconds_list</span><span class="o">:</span>
    <span class="n">statistics_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;  单次最小耗时(秒): {:.3f}&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">min</span><span class="o">(</span><span class="n">elapsed_seconds_list</span><span class="o">)))</span>
    <span class="n">statistics_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;  单次最大耗时(秒): {:.3f}&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">max</span><span class="o">(</span><span class="n">elapsed_seconds_list</span><span class="o">)))</span>
    <span class="n">statistics_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;  单次平均耗时(秒): {:.3f}&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="n">elapsed_seconds_list</span><span class="o">)/</span><span class="n">success_count</span><span class="o">))</span>
<span class="n">statistics_list</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s1">&#39;  每秒请求次数: {:.2f}&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">((</span><span class="n">test_count</span> <span class="o">-</span> <span class="n">unresponse_count</span><span class="o">)/</span><span class="n">total_elapsed</span><span class="o">))</span>
<span class="k">return</span> <span class="s1">&#39;\r\n&#39;</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">statistics_list</span><span class="o">)</span>
</pre></div>


<p>def _get_test_index() -&gt; list:
    """测到测试信息</p>
<div class="highlight"><pre><span></span><span class="n">Returns</span><span class="o">:</span>
    <span class="err">返回测试信息列表</span>

<span class="s2">&quot;&quot;</span><span class="err">&quot;</span>
<span class="err">#</span> <span class="err">打印测试菜单</span>
<span class="n">print</span><span class="o">(</span><span class="s1">&#39;\r\n        -------------------- 欢迎使用web页面性能测试 --------------------\r\n\r\n请选择测试页面(Quit):&#39;</span><span class="o">)</span>
<span class="n">test_info_list</span> <span class="o">=</span> <span class="n">get_predefined_test_page_list</span><span class="o">()</span>
<span class="n">test_count</span> <span class="o">=</span> <span class="n">len</span><span class="o">(</span><span class="n">test_info_list</span><span class="o">)</span>
<span class="k">for</span> <span class="n">test_index</span><span class="o">,</span> <span class="n">test_info</span> <span class="k">in</span> <span class="n">enumerate</span><span class="o">(</span><span class="n">test_info_list</span><span class="o">):</span>
    <span class="n">name</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">url</span><span class="o">,</span> <span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">test_info</span>
    <span class="n">print</span><span class="o">(</span><span class="s1">&#39;    {}. {}({}:{}{})&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">test_index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">url</span><span class="o">))</span>
<span class="n">print</span><span class="o">(</span><span class="s1">&#39;    {}. 自定义&#39;</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">test_count</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
<span class="err">#</span> <span class="err">选择测试主页</span>
<span class="n">test_index_1</span> <span class="o">=</span> <span class="mi">0</span>  <span class="err">#</span><span class="mi">1</span><span class="err">基索引</span>
<span class="k">while</span> <span class="n">not</span> <span class="n">test_index_1</span><span class="o">:</span>
    <span class="n">test_index_1</span> <span class="o">=</span> <span class="n">input</span><span class="o">(</span><span class="s1">&#39;请选择测试页面(Quit):&#39;</span><span class="o">)</span>
    <span class="k">if</span> <span class="n">not</span> <span class="n">test_index_1</span><span class="o">.</span><span class="na">isdigit</span><span class="o">():</span>
        <span class="k">return</span> <span class="o">[]</span>
<span class="n">assert</span> <span class="n">test_index_1</span> <span class="n">and</span> <span class="n">test_index_1</span><span class="o">.</span><span class="na">isdigit</span><span class="o">()</span>
<span class="n">test_index</span> <span class="o">=</span> <span class="n">int</span><span class="o">(</span><span class="n">test_index_1</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="k">if</span> <span class="n">test_index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="n">and</span> <span class="n">test_index</span> <span class="o">&lt;</span> <span class="n">test_count</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">test_info_list</span><span class="o">[</span><span class="n">test_index</span><span class="o">]</span>
<span class="k">else</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">_get_custom_test_info</span><span class="o">()</span>
</pre></div>


<p>def _get_custom_test_info() -&gt; list:
    """得到自定义测试信息</p>
<div class="highlight"><pre><span></span><span class="n">Returns</span><span class="o">:</span>
    <span class="err">返回测试信息列表</span>

<span class="s2">&quot;&quot;&quot;</span>
<span class="s2">test_info = [&#39;自定义&#39;,]</span>
<span class="s2">for value_info in ((&#39;服务器地址&#39;, None, str),</span>
<span class="s2">                   (&#39;端口&#39;, &#39;80&#39;, int),</span>
<span class="s2">                   (&quot;</span><span class="n">url_path</span><span class="s2">&quot;, &#39;/&#39;, str),</span>
<span class="s2">                   (&quot;</span><span class="err">测试次数</span><span class="s2">&quot;, &#39;50&#39;, int),</span>
<span class="s2">                   (&quot;</span><span class="err">页面内容列表</span><span class="o">(</span><span class="err">分号分隔</span><span class="o">)</span><span class="s2">&quot;, None, str),</span>
<span class="s2">                   (&#39;超时秒数&#39;, &#39;50&#39;, int)):</span>
<span class="s2">    key, default_value, value_type = value_info</span>
<span class="s2">    prompt = &#39;请输入&quot;</span><span class="o">{}</span><span class="s2">&quot;({}):&#39;.format(key, default_value) if default_value else &#39;请输入&quot;</span><span class="o">{}</span><span class="err">&quot;</span><span class="o">:</span><span class="s1">&#39;.format(key)</span>
<span class="s1">    value = &#39;&#39;</span>
<span class="s1">    while not value:</span>
<span class="s1">        value = input(prompt)</span>
<span class="s1">        if not value and default_value:</span>
<span class="s1">            value = default_value</span>
<span class="s1">    if not isinstance(value, value_type):</span>
<span class="s1">        value = value_type(value)</span>
<span class="s1">    if key == &#39;</span><span class="err">页面内容列表</span><span class="o">(</span><span class="err">分号分隔</span><span class="o">)</span><span class="s1">&#39;:</span>
<span class="s1">        value = value.split(&#39;</span><span class="o">;</span><span class="err">&#39;</span><span class="o">)</span>
    <span class="n">test_info</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
<span class="k">return</span> <span class="n">test_info</span>
</pre></div>


<h6>######################## 入口流程</h6>
<p>def main():
    """程序入口"""
    # 得到测试信息
    test_info = _get_test_index()
    if not test_info:
        return
    name, host, port, url, test_count, expect_content_list, timeout_seconds = test_info
    # 执行测试
    if sys.platform == 'win32':
        loop = asyncio.ProactorEventLoop()
        asyncio.set_event_loop(loop)
    loop = asyncio.get_event_loop()
    loop.run_until_complete(web_performance_test(name, host, port, url, test_count, expect_content_list, timeout_seconds))</p>
<p>if <strong>name</strong> == '<strong>main</strong>':
    main()</p>
<p>'''</p>
  </div>
</article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
       <ul class="col-sm-6 list-inline">
          <li class="list-inline-item"><a href="/authors.html">Authors</a></li>
          <li class="list-inline-item"><a href="/archives.html">Archives</a></li>
          <li class="list-inline-item"><a href="/categories.html">Categories</a></li>
        </ul>
        <p class="col-sm-6 text-sm-right text-muted">
          Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a> / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
        </p>
      </div>
    </div>
  </footer>
</body>

</html>