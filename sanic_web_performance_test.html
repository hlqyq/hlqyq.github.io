<!DOCTYPE html>
<html lang="chinese (simplified)">

<head>
  <!-- Required meta tags always come first -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>sanic web性能测试脚本 | 编程岁月
</title>
  <link rel="canonical" href="/sanic_web_performance_test.html">



  <link rel="stylesheet" href="/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="/theme/css/style.css">


<meta name="description" content="sanic是新的python web异步微框架,windows下的安装,可用于web性能测试。 测试环境 操作系统: windows 10 专业版 python: 3.6.4 安装目录为: c:\python36 httptools: 0.0.10 sanic: 0.7.0 测试脚本 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 …">
</head>

<body>
  <header class="header">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1 class="title"><a href="">编程岁月</a></h1>
          <p class="text-muted">无名</p>
          <ul class="list-inline">
            <li class="list-inline-item"><a href="https://github.com/hlqyq" target="_blank">github</a></li>
            <li class="list-inline-item"><a href="http://blog.justtodo.com/" target="_blank">晓月刀</a></li>
            <li class="list-inline-item"><a href="http://www.csew.cn/" target="_blank">易睿</a></li>
            <li class="list-inline-item"><a href="http://blog.csdn.net/hlqyq/" target="_blank">博客</a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>sanic web性能测试脚本
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2018-01-02T00:00:00+08:00">
        <i class="fa fa-clock-o"></i>
        周二 02 一月 2018
      </li>
      <li class="list-inline-item">
        <i class="fa fa-folder-open-o"></i>
        <a href="/category/bands.html">bands</a>
      </li>
      <li class="list-inline-item">
        <i class="fa fa-user-o"></i>
        <a href="/author/hu-le-qiu.html">胡乐秋</a>      </li>
    </ul>
  </header>
  <div class="content">
    <p>sanic是新的python web异步微框架,windows下的<a href="https://hlqyq.github.io/sanic_windows_install.html">安装</a>,可用于web性能测试。</p>
<h1>测试环境</h1>
<ul>
<li>操作系统: windows 10 专业版</li>
<li>python: 3.6.4 安装目录为: c:\python36</li>
<li>httptools: 0.0.10</li>
<li>sanic: 0.7.0</li>
</ul>
<h1>测试脚本</h1>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python3.6</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;web页面性能测试&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1">############################## 元信息 ##############################</span>

<span class="k">def</span> <span class="nf">get_predefined_test_page_list</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;得到预定义的测试页面列表: [[name, host, port, url, test_count, expect_content_list, timeout_seconds], ...]</span>

<span class="sd">    Returns:</span>
<span class="sd">        返回预定义测试页面列表</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;微信&#39;</span><span class="p">,</span> <span class="s1">&#39;weixin.qq.com&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;是一个生活方式&#39;</span><span class="p">,],</span> <span class="mi">50</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;百度&#39;</span><span class="p">,</span> <span class="s1">&#39;www.baidu.com&#39;</span><span class="p">,</span> <span class="mi">443</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;百度一下&#39;</span><span class="p">,],</span> <span class="mi">50</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;新浪&#39;</span><span class="p">,</span> <span class="s1">&#39;www.sina.com.cn&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;微博&#39;</span><span class="p">,],</span> <span class="mi">50</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;本机主页&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">],</span> <span class="mi">50</span><span class="p">),]</span>

<span class="c1">############################## 接口函数 ##############################</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">web_performance_test</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">test_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">expect_content_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;执行web性能测试</span>

<span class="sd">    Args:</span>
<span class="sd">        host: 服务器地址</span>
<span class="sd">        port: 服务器端口</span>
<span class="sd">        url: 服务器url</span>
<span class="sd">        test_count: 访问测试次数</span>
<span class="sd">        expect_content_list: 期望返回的页面包含内容列表</span>
<span class="sd">        timeout_seconds: 超时设置</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 开始计时并访问网页</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{}({}:{}{})压力测试(次数:{})...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">test_count</span><span class="p">))</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">_fetch</span><span class="p">(</span><span class="n">test_index</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">expect_content_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">test_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_count</span><span class="p">)],</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_EXCEPTION</span><span class="p">)</span>
    <span class="n">total_elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
    <span class="c1"># 执行统计</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_statistics_performance</span><span class="p">(</span><span class="n">test_count</span><span class="p">,</span> <span class="n">total_elapsed</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">done</span><span class="p">])))</span>

<span class="c1">############################## 实现 ##############################</span>

<span class="n">REGEX_CONTENT_LENGTH</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\r\nContent-Length: ([0-9]+)\r\n&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_content_length</span><span class="p">(</span><span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;根据http头得到内容长度</span>

<span class="sd">    Args:</span>
<span class="sd">        header: 响应头内容</span>

<span class="sd">    Returns:</span>
<span class="sd">        返回内容长度</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">REGEX_CONTENT_LENGTH</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">_fetch</span><span class="p">(</span><span class="n">test_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expect_content_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;访问指定网页</span>

<span class="sd">    Args:</span>
<span class="sd">        test_index: 测试次数索引</span>
<span class="sd">        host: 服务器地址</span>
<span class="sd">        port: 服务器端口</span>
<span class="sd">        url: 服务器url</span>
<span class="sd">        expect_content_list: 期望返回的页面包含内容列表</span>

<span class="sd">    Returns:</span>
<span class="sd">        返回(True, {elapsed_seconds})或(False, {error_message})</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 输出信息</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">test_index</span> <span class="o">%</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="c1"># 建立连接</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
    <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">open_connection</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="mi">443</span><span class="p">))</span>
    <span class="c1"># 发送请求</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;GET {path} HTTP/1.0</span><span class="se">\r\n</span><span class="s1">&#39;</span>
             <span class="s1">&#39;Host: {hostname}</span><span class="se">\r\n</span><span class="s1">&#39;</span>
             <span class="s1">&#39;User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:50.0) Gecko/20100101 Firefox/50.0</span><span class="se">\r\n</span><span class="s1">&#39;</span>
             <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="n">host</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">))</span>
    <span class="c1"># 读入头信息</span>
    <span class="n">headers_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">header_crlf</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">header_crlf</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">await</span> <span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">header_crlf</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="c1"># 获得内容长度</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers_list</span><span class="p">)</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="n">_get_content_length</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
    <span class="c1"># 读入内容</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">content_length</span><span class="p">:</span>
        <span class="n">content_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">readed_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">readed_length</span> <span class="o">&lt;</span> <span class="n">content_length</span><span class="p">:</span>
            <span class="n">read_length</span> <span class="o">=</span> <span class="n">content_length</span> <span class="o">-</span> <span class="n">readed_length</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">await</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">read_length</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
                <span class="n">readed_length</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="n">content_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content_list</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="c1"># 关闭socket</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
    <span class="c1"># 判断成功与否标志</span>
    <span class="n">success</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.&#39;</span> <span class="ow">in</span> <span class="n">headers</span> <span class="ow">and</span> <span class="s1">&#39;200&#39;</span> <span class="ow">in</span> <span class="n">headers</span>
    <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;返回状态码错误: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">headers_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">success</span> <span class="ow">and</span> <span class="n">expect_content_list</span> <span class="ow">and</span> <span class="n">content</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">expect_content</span> <span class="ow">in</span> <span class="n">expect_content_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expect_content</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;服务器响应未包含期望内容:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expect_content</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="c1"># 输出信息</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">test_index</span> <span class="o">%</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="c1"># 返回</span>
    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error_message</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;{}</span><span class="se">\r\n</span><span class="s1">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_statistics_performance</span><span class="p">(</span><span class="n">test_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">total_elapsed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fetch_result_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;统计测试结果</span>

<span class="sd">    Args:</span>
<span class="sd">        test_count: 总测试次数</span>
<span class="sd">        total_elapsed: 总耗时</span>
<span class="sd">        fetch_result_list: 测试结果列表</span>

<span class="sd">    Returns:</span>
<span class="sd">        返回统计信息</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 分离成功与失败结果</span>
    <span class="n">elapsed_seconds_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed_response_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unresponse_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">fetch_result</span> <span class="ow">in</span> <span class="n">fetch_result_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fetch_result</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fetch_result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">result_or_error</span> <span class="o">=</span> <span class="n">fetch_result</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">elapsed_seconds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_or_error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">failed_response_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_or_error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failed_response_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;无返回值&#39;</span><span class="p">)</span>
            <span class="n">unresponse_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">success_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elapsed_seconds_list</span><span class="p">)</span>
    <span class="n">failed_count</span> <span class="o">=</span> <span class="n">test_count</span> <span class="o">-</span> <span class="n">success_count</span>
    <span class="c1"># 打印统计信息</span>
    <span class="n">statistics_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">failed_response_list</span><span class="p">:</span>
        <span class="n">statistics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">失败({}次)原因: </span><span class="se">\r\n</span><span class="s1">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">failed_response_list</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">failed_response_list</span><span class="p">)))</span>
    <span class="n">statistics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">统计结果:&#39;</span><span class="p">)</span>
    <span class="n">statistics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  测试次数: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_count</span><span class="p">))</span>
    <span class="n">statistics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  成功次数: {}    成功率: {:.2f}%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">success_count</span><span class="p">,</span> <span class="n">success_count</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">test_count</span><span class="p">))</span>
    <span class="n">statistics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  失败次数: {}    失败率: {:.2f}%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_count</span> <span class="o">-</span> <span class="n">success_count</span><span class="p">,</span> <span class="n">failed_count</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">test_count</span><span class="p">))</span>
    <span class="n">statistics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  总耗时(秒): {:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_elapsed</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">elapsed_seconds_list</span><span class="p">:</span>
        <span class="n">statistics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  单次最小耗时(秒): {:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">elapsed_seconds_list</span><span class="p">)))</span>
        <span class="n">statistics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  单次最大耗时(秒): {:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">elapsed_seconds_list</span><span class="p">)))</span>
        <span class="n">statistics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  单次平均耗时(秒): {:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">elapsed_seconds_list</span><span class="p">)</span><span class="o">/</span><span class="n">success_count</span><span class="p">))</span>
    <span class="n">statistics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  每秒请求次数: {:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">test_count</span> <span class="o">-</span> <span class="n">unresponse_count</span><span class="p">)</span><span class="o">/</span><span class="n">total_elapsed</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">statistics_list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_test_index</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;测到测试信息列表</span>

<span class="sd">    Returns:</span>
<span class="sd">        返回测试信息列表</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 打印测试菜单</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">        -------------------- 欢迎使用web页面性能测试 --------------------</span><span class="se">\r\n\r\n</span><span class="s1">请选择测试页面(Quit):&#39;</span><span class="p">)</span>
    <span class="n">test_info_list</span> <span class="o">=</span> <span class="n">get_predefined_test_page_list</span><span class="p">()</span>
    <span class="n">test_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_info_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">test_index</span><span class="p">,</span> <span class="n">test_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_info_list</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">test_info</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;    {}. {}({}:{}{})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;    {}. 自定义&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># 选择测试主页</span>
    <span class="n">test_index_1</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#1基索引</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">test_index_1</span><span class="p">:</span>
        <span class="n">test_index_1</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;请选择测试页面(Quit):&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_index_1</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[]</span>
    <span class="k">assert</span> <span class="n">test_index_1</span> <span class="ow">and</span> <span class="n">test_index_1</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span>
    <span class="n">test_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_index_1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">test_index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">test_index</span> <span class="o">&lt;</span> <span class="n">test_count</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">test_info_list</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_get_custom_test_info</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_get_custom_test_info</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;得到自定义测试信息</span>

<span class="sd">    Returns:</span>
<span class="sd">        返回测试信息列表</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_info</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;自定义&#39;</span><span class="p">,]</span>
    <span class="k">for</span> <span class="n">value_info</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;服务器地址&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;端口&#39;</span><span class="p">,</span> <span class="s1">&#39;80&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;url_path&quot;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;测试次数&quot;</span><span class="p">,</span> <span class="s1">&#39;50&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;页面内容列表(分号分隔)&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
                       <span class="p">(</span><span class="s1">&#39;超时秒数&#39;</span><span class="p">,</span> <span class="s1">&#39;50&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">,</span> <span class="n">value_type</span> <span class="o">=</span> <span class="n">value_info</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="s1">&#39;请输入&quot;{}&quot;({}):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">default_value</span> <span class="k">else</span> <span class="s1">&#39;请输入&quot;{}&quot;:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">default_value</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">default_value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value_type</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;页面内容列表(分号分隔)&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="n">test_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_info</span>

<span class="c1">############################## 入口流程 ##############################</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;程序入口&quot;&quot;&quot;</span>
    <span class="c1"># 得到测试信息</span>
    <span class="n">test_info</span> <span class="o">=</span> <span class="n">_get_test_index</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">test_info</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">test_count</span><span class="p">,</span> <span class="n">expect_content_list</span><span class="p">,</span> <span class="n">timeout_seconds</span> <span class="o">=</span> <span class="n">test_info</span>
    <span class="c1"># 执行测试</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ProactorEventLoop</span><span class="p">()</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">web_performance_test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">test_count</span><span class="p">,</span> <span class="n">expect_content_list</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>

<div id="container"></div>

<p><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  id: 'sanic_web_performance_test',
  owner: 'hlqyq',
  repo: 'hlqyq.github.io',
  oauth: {
    client_id: '1f7a240da8bcca1563a9',
    client_secret: '2a59d57ab5b48ce420724d3032ce9cc099b00661',
  },
})
gitment.render('container')
</script></p>
  </div>
</article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
       <ul class="col-sm-6 list-inline">
          <li class="list-inline-item"><a href="/authors.html">Authors</a></li>
          <li class="list-inline-item"><a href="/archives.html">Archives</a></li>
          <li class="list-inline-item"><a href="/categories.html">Categories</a></li>
        </ul>
        <p class="col-sm-6 text-sm-right text-muted">
          Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a> / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
        </p>
      </div>
    </div>
  </footer>
</body>

</html>